{% extends "base.html" %}
{% block title %}ê´€ë¦¬ì ì˜ˆì•½ í™•ì¸{% endblock %}

{% block content %}
    <div style="margin-bottom: 20px;">
        <a href="#section-in" style="margin-right: 20px;">ğŸ”µ ì•ˆìª½ ì˜ˆì•½ìœ¼ë¡œ ì´ë™</a>
        <a href="#section-out">ğŸŸ¢ ë°”ê¹¥ìª½ ì˜ˆì•½ìœ¼ë¡œ ì´ë™</a>
    </div>

    <h2>ê´€ë¦¬ì ì˜ˆì•½ í˜„í™©</h2>

    <form method="post">
        <div style="margin-bottom: 10px">
            <label>ì˜ˆì•½ ì˜¤í”ˆ ì‹œê°„: </label>
            <input name="open_time" type="datetime-local" value="{{ open_time }}">
            <button type="submit" name="action" value="set_open">ì €ì¥</button>
        </div>

        <div style="margin-bottom: 10px">
            <label>ì´ë¦„:</label>
            <input name="admin_name" placeholder="ì´ë¦„ ì…ë ¥">
            <label>ì‹œê°„:</label>
            <input name="admin_time" placeholder="ì˜ˆ: 2025-05-25 10:30 (ì•ˆ)">
            <button type="submit" name="action" value="add_reservation">ì˜ˆì•½ ì¶”ê°€</button>
        </div>

        <div style="margin-bottom: 10px">
            <button type="submit" name="action" value="reset_used">ì´ìš©ì™„ë£Œ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
    </form>

    <hr>

    <h3 id="section-in">ğŸ”µ ì•ˆìª½ ì˜ˆì•½</h3>

    {% for time, slots in grouped.items() if '(ì•ˆ)' in time %}
        <table border="1" cellpadding="5" style="margin-bottom: 20px; border-collapse: collapse;">
            <caption style="font-weight: bold; margin-bottom: 5px;">ğŸ•’ {{ time }}</caption>
            <tr>
                <th>ì˜ˆì•½ì</th>
                <th>ë²ˆí˜¸</th>
                <th>ì´ìš© ì™„ë£Œ</th>
                <th>ì‚­ì œ</th>
            </tr>
            {% for r in slots %}
                <tr>
                    <td>{{ r.name }}</td>
                    <td>{{ r.order_in_slot }}</td>
                    <td>
                        <button type="button" onclick="toggleUsed({{ r.id }}, this)">
                            {{ "âœ…" if r.used else "âŒ" }}
                        </button>

                    </td>
                    <td>
                        <button type="button" onclick="deleteReservation({{ r.id }}, this)">ì‚­ì œ</button>

                    </td>
                </tr>
            {% endfor %}
        </table>
    {% endfor %}

    <h3 id="section-out">ğŸŸ¢ ë°”ê¹¥ìª½ ì˜ˆì•½</h3>

    {% for time, slots in grouped.items() if '(ë°–)' in time or '(ì•ˆ)' not in time %}
        <table border="1" cellpadding="5" style="margin-bottom: 20px; border-collapse: collapse;">
            <caption style="font-weight: bold; margin-bottom: 5px;">ğŸ•’ {{ time }}</caption>
            <tr>
                <th>ì˜ˆì•½ì</th>
                <th>ë²ˆí˜¸</th>
                <th>ì´ìš© ì™„ë£Œ</th>
                <th>ì‚­ì œ</th>
            </tr>
            {% for r in slots %}
                <tr>
                    <td>{{ r.name }}</td>
                    <td>{{ r.order_in_slot }}</td>
                    <td>
                        <button type="button" onclick="toggleUsed({{ r.id }}, this)">
                            {{ "âœ…" if r.used else "âŒ" }}
                        </button>
                    </td>
                    <td>
                        <button type="button" onclick="deleteReservation({{ r.id }}, this)">ì‚­ì œ</button>

                    </td>
                </tr>
            {% endfor %}
        </table>
    {% endfor %}
    <script>
        function toggleUsed(id, btn) {
            fetch("/admin/toggle_used", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `id=${id}`
            }).then(res => {
                if (res.ok) {
                    btn.textContent = (btn.textContent === "âœ…") ? "âŒ" : "âœ…";
                } else {
                    alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨");
                }
            });
        }

        function deleteReservation(id, btn) {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            fetch("/admin/delete_reservation", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `reservation_id=${id}`
            }).then(res => {
                if (res.ok) {
                    const row = btn.closest("tr");
                    row?.remove();
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            });
        }
    </script>


    <a class="action-link" href="/">â† ë©”ì¸ìœ¼ë¡œ</a>
{% endblock %}
