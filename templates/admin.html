@app.route("/admin", methods=["GET", "POST"])
@admin_required
def admin():
conn = get_connection()
cur = conn.cursor(cursor_factory=RealDictCursor)

action = request.form.get("action")

# ✅ POST 처리
if request.method == "POST":
if action == "reset_used":
cur.execute("UPDATE reservations SET used = FALSE")

elif action == "set_open":
open_time_val = request.form.get("open_time")
# datetime-local → 정규 포맷으로 저장 (선택사항)
try:
dt = datetime.strptime(open_time_val, "%Y-%m-%dT%H:%M")
formatted = dt.strftime("%Y-%m-%d %H:%M")
except:
formatted = open_time_val  # fallback
cur.execute("""
INSERT INTO settings (key, value)
VALUES ('open_time', %s)
ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value
""", (formatted,))

elif action == "add_reservation":
name = request.form.get("admin_name")
timeslot = request.form.get("admin_time")
if name and timeslot:
cur.execute("SELECT COUNT(*) as count FROM reservations WHERE timeslot = %s", (timeslot,))
count = cur.fetchone()['count']
if count < 3:
order_in_slot = count + 1
cur.execute("""
INSERT INTO reservations (name, timeslot, order_in_slot)
VALUES (%s, %s, %s)
""", (name, timeslot, order_in_slot))

conn.commit()

# ✅ 예약 목록 조회 및 그룹화
cur.execute("SELECT * FROM reservations ORDER BY timeslot, order_in_slot")
reservations = cur.fetchall()

from collections import defaultdict
grouped = defaultdict(list)
for r in reservations:
grouped[r["timeslot"]].append(r)

# ✅ 오픈 시간 불러오기 및 포맷 처리
cur.execute("SELECT value FROM settings WHERE key = 'open_time'")
row = cur.fetchone()

open_time = ""
if row and row.get("value"):
raw_time = row["value"].strip()
try:
dt = datetime.strptime(raw_time, "%Y-%m-%d %H:%M")
open_time = dt.strftime("%Y-%m-%dT%H:%M")
except ValueError:
try:
dt = datetime.strptime(raw_time, "%Y-%m-%dT%H:%M")
open_time = dt.strftime("%Y-%m-%dT%H:%M")
except:
print("⚠️ 오픈 시간 파싱 실패:", raw_time)
open_time = ""

cur.close()
conn.close()

return render_template("admin.html", grouped=grouped, open_time=open_time)


@app.route("/admin/delete_reservation", methods=["POST"])
@admin_required
def delete_reservation():
reservation_id = request.form.get("reservation_id")
conn = get_connection()
cur = conn.cursor()
cur.execute("DELETE FROM reservations WHERE id = %s", (reservation_id,))
conn.commit()
cur.close()
conn.close()
return redirect("/admin")


@app.route("/admin/toggle_used", methods=["POST"])
@admin_required
def toggle_used():
reservation_id = request.form.get("id")
conn = get_connection()
cur = conn.cursor()
cur.execute("UPDATE reservations SET used = NOT used WHERE id = %s", (reservation_id,))
conn.commit()
cur.close()
conn.close()
return redirect("/admin")
