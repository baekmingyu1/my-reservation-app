{% extends "base.html" %}
{% block title %}포토존 순서 예약하기{% endblock %}

{% block extra_head %}
    <style>
        .modal {
            display: none; position: fixed; z-index: 10; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 300px; text-align: center;
        }
        .modal-buttons button {
            margin: 10px; padding: 10px 20px; font-size: 16px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="title">포토존 순서 예약하기</div>

    <form method="post" id="reservationForm">
        <div class="name-row">
            <div class="label">이름 :</div>
            <div class="input-wrapper" style="gap: 8px;">
                <input id="nameInput" class="input-box" name="name" placeholder="이름을 입력해주세요" required style="min-width: 180px;" />
                <span style="font-size: 16px;">가교/결</span>
            </div>
        </div>

        {% if message %}
            <div class="message">{{ message }}</div>
        {% endif %}

        <div class="slot-section">
            <div class="label">시간 선택</div>
            <div class="slots">
                {% for slot in timeslots %}
                    {% set time_text = slot.time %}
                    {% if "12:30" <= time_text[11:] %}
                        <button type="button" class="slot" onclick="openModal('{{ time_text }}')">
                            {{ time_text[11:] }} ({{ slot.count }}/3)
                        </button>
                    {% else %}
                        <button class="slot {% if slot.full %}full{% endif %}" name="timeslot" value="{{ time_text }}" type="submit" {% if slot.full %}disabled{% endif %}>
                            {{ time_text[11:] }} ({{ slot.count }}/3)
                        </button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </form>

    <!-- ✅ 모달 -->
    <div id="timeModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-time-label">시간 예약</h3>
            <form method="post">
                <input type="hidden" name="name" id="modal-name" />
                <input type="hidden" name="timeslot" id="modal-timeslot" />
                <div class="modal-buttons">
                    <button type="submit" onclick="setArea('안')">
                        <span id="in-label">안쪽</span>
                    </button>
                    <button type="submit" onclick="setArea('밖')">
                        <span id="out-label">바깥</span>
                    </button>
                    <button type="button" onclick="closeModal()">닫기</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const timeslotCounts = {{ timeslot_counts | tojson }};
        let selectedTime = "";

        function openModal(time) {
            selectedTime = time;
            const nameValue = document.getElementById("nameInput").value.trim();
            if (!nameValue) {
                alert("이름을 먼저 입력해주세요.");
                return;
            }
            document.getElementById("modal-name").value = nameValue;
            document.getElementById("modal-time-label").innerText = time.slice(11) + " 시간 예약";
            document.getElementById("modal-timeslot").value = ""; // 초기화

            const inCount = timeslotCounts[time]?.in ?? "?";
            const outCount = timeslotCounts[time]?.out ?? "?";
            document.getElementById("in-label").innerText = `안쪽 (${inCount}자리 남음)`;
            document.getElementById("out-label").innerText = `바깥 (${outCount}자리 남음)`;

            document.getElementById("timeModal").style.display = "flex";
        }

        function setArea(area) {
            document.getElementById("modal-timeslot").value = selectedTime + " (" + area + ")";
        }

        function closeModal() {
            document.getElementById("timeModal").style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target === document.getElementById("timeModal")) {
                closeModal();
            }
        }
    </script>
{% endblock %}
